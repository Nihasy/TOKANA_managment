generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  COURIER
}

enum DeliveryStatus {
  CREATED
  PICKED_UP
  DELIVERED
  PAID
  POSTPONED
  CANCELED
}

enum PickupZone {
  TANA_VILLE
  PERIPHERIE
  SUPER_PERIPHERIE
}

enum SettlementType {
  CASH_COURIER    // Cash livré par livreur
  MOBILE_MONEY    // Mobile Money
  OFFICE_PICKUP   // Récupéré au siège par le client
}

model User {
  id         String     @id @default(cuid())
  email      String     @unique
  password   String
  name       String
  role       Role
  phone      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  deliveries Delivery[] @relation("CourierDeliveries")
}

model Client {
  id            String     @id @default(cuid())
  name          String
  phone         String
  pickupAddress String
  pickupZone    PickupZone @default(TANA_VILLE)
  note          String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deliveries    Delivery[] @relation("SenderClient")
}

model Delivery {
  id              String         @id @default(cuid())
  plannedDate     DateTime
  senderId        String
  sender          Client         @relation("SenderClient", fields: [senderId], references: [id])
  receiverName    String
  receiverPhone   String
  receiverAddress String

  parcelCount   Int     @default(1)
  weightKg      Float   @default(1)
  description   String?
  note          String?
  courierRemarks String?

  collectAmount Int?
  deliveryPrice Int
  autoPrice     Int
  totalDue      Int

  // Payment tracking
  isPrepaid Boolean @default(false) // Si le client et destinataire ont déjà réglé entre eux
  deliveryFeePrepaid Boolean @default(false) // Si les frais de livraison ont été payés d'avance par le client
  
  // Règlement livreur (réception de l'argent du livreur)
  courierSettled Boolean @default(false) // Si l'argent a été reçu du livreur
  courierSettledAt DateTime? // Date de réception de l'argent du livreur
  courierSettledBy String? // Admin qui a confirmé la réception
  
  // Règlement client (versement au client J+1)
  isSettled Boolean @default(false) // Si le règlement au client a été effectué
  settledAt DateTime?
  settledBy String? // Admin qui a effectué le règlement
  settlementType SettlementType? // Type de remise (Cash/Mobile Money/Siège)

  status      DeliveryStatus @default(CREATED)
  postponedTo DateTime?

  courierId String?
  courier   User?   @relation("CourierDeliveries", fields: [courierId], references: [id])

  isExpress Boolean @default(false)
  zone      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
